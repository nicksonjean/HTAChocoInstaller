<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="favicon/favicon.ico" type="image/x-icon" />
    <link rel="shortcut icon" href="favicon/favicon.ico" type="image/x-icon" />
    <link rel="icon" type="image/png" href="favicon/favicon.png" />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.1.0/css/all.css"
      integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt"
      crossorigin="anonymous"
    />
    <title>Search Packages</title>
  </head>

  <body>
    <div class="container">
      <br />
      <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-8">
          <form class="card card-sm">
            <div class="card-body row no-gutters align-items-center">
              <div class="col-auto">
                <i class="fas fa-search h4 text-body"></i>
              </div>
              <!--end of col-->
              <div class="col">
                <input
                  id="package"
                  class="form-control form-control-lg form-control-borderless"
                  type="search"
                  placeholder="Search packages"
                  value=""
                  autocomplete="off"
                  style="border-radius: 2rem; margin-left: 5px; width: 98%"
                />
              </div>
              <!--end of col-->
              <div class="col-auto">
                <button
                  id="getSearch"
                  class="btn btn-lg btn-success"
                  type="button"
                >
                  Search
                </button>
              </div>
              <!--end of col-->
            </div>
          </form>
        </div>
        <!--end of col-->
      </div>
    </div>
    <div
      class="
        container
        justify-content-center
        list-unstyled
        pt-3
        package-list-view
      "
    >
      <ul id="resultList" style="list-style: none"></ul>
    </div>

    <script src="../assets/js/Ajax.js"></script>
    <script type="text/javascript">
      if (window.NodeList && !NodeList.prototype.forEach)
        NodeList.prototype.forEach = Array.prototype.forEach;

      var RemotelyPackages = [];
      var ChocoURLJS = "https://community.chocolatey.org";

      function parseHTML(markup) {
        if (markup.toLowerCase().trim().indexOf("<!doctype") === 0) {
          var doc = document.implementation.createHTMLDocument("");
          doc.documentElement.innerHTML = markup;
          return doc;
        } else if ("content" in document.createElement("template")) {
          var el = document.createElement("template");
          el.innerHTML = markup;
          return el.content;
        } else {
          var docfrag = document.createDocumentFragment();
          var el = document.createElement("body");
          el.innerHTML = markup;
          for (i = 0; 0 < el.childNodes.length; ) {
            docfrag.appendChild(el.childNodes[i]);
          }
          return docfrag;
        }
      }

      function fetchPackageList(packageName) {
        var proxies = [
          "https://api.allorigins.win/get?url=",
          "https://api.allorigins.win/get?url=",
        ];
        var loadBalance = function (min, max) {
          return Math.floor(Math.random() * (max - min + 1) + min);
        };
        var parsePackageName = function (proxyURL, packageName) {
          return (
            proxyURL +
            encodeURIComponent(
              ChocoURLJS + "/packages?q=" + packageName.replace(/\s{1,}/gm, "+")
            )
          );
        };
        var proxyURLChosed = proxies[loadBalance(0, 1)];
        return ajax.get(
          parsePackageName(proxyURLChosed, packageName),
          null,
          fetchList,
          false
        );
      }

      function fetchList(data) {
        //var response = JSON.parse(data).contents ?? JSON.parse(data),
        var response = JSON.parse(data).contents,
          parse_html = parseHTML(response),
          list = parse_html.querySelectorAll(".package-list-view li"),
          packageNameRegex = /(.*)<.*>.*<\/.*>/gm,
          packageVersionRegex = /.*<.*>(.*)<\/.*>/gm,
          packageImageRegex = /file:\/{1,}[A-Z]\:/gm;

        return list.forEach(function (item, i) {
          if (
            item.querySelector("a.h5") &&
            item.querySelector("div.input-group input")
          ) {
            var packageObject = {
              packageName: item
                .querySelector("a.h5")
                .innerHTML.replace(packageNameRegex, "$1")
                .trim(),
              packageVersion: item
                .querySelector("a.h5")
                .innerHTML.replace(packageVersionRegex, "$1"),
              packageIcon:
                ChocoURLJS +
                item.querySelector("img").src.replace(packageImageRegex, ""),
              packageCommand: item.querySelector("input").value,
            };
            RemotelyPackages.push(packageObject);
          }
        });
      }

      fetchPackageList("adobe");
      console.log(RemotelyPackages);

      //https://stackoverflow.com/questions/43521856/cross-domain-javascript-calls-using-jsonp-or-cors
      //https://stackoverflow.com/questions/36568923/cors-error-with-ajax-request
    </script>
    <script
      src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
      integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/gh/xcash/bootstrap-autocomplete@v2.3.0/dist/latest/bootstrap-autocomplete.min.js"></script>
  </body>
</html>
