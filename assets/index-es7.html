<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="favicon/favicon.ico" type="image/x-icon" />
    <link rel="shortcut icon" href="favicon/favicon.ico" type="image/x-icon" />
    <link rel="icon" type="image/png" href="favicon/favicon.png" />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.1.0/css/all.css"
      integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt"
      crossorigin="anonymous"
    />
    <title>Search Packages</title>
  </head>

  <body>
    <div class="container">
      <br />
      <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-8">
          <form class="card card-sm">
            <div class="card-body row no-gutters align-items-center">
              <div class="col-auto">
                <i class="fas fa-search h4 text-body"></i>
              </div>
              <!--end of col-->
              <div class="col">
                <input
                  id="package"
                  class="form-control form-control-lg form-control-borderless"
                  type="search"
                  placeholder="Search packages"
                  value=""
                  autocomplete="off"
                  style="border-radius: 2rem; margin-left: 5px; width: 98%"
                />
              </div>
              <!--end of col-->
              <div class="col-auto">
                <button
                  id="getSearch"
                  class="btn btn-lg btn-success"
                  type="button"
                >
                  Search
                </button>
              </div>
              <!--end of col-->
            </div>
          </form>
        </div>
        <!--end of col-->
      </div>
    </div>
    <div
      class="
        container
        justify-content-center
        list-unstyled
        pt-3
        package-list-view
      "
    >
      <ul id="resultList" style="list-style: none"></ul>
    </div>

    <script type="text/javascript">
      // https://stackoverflow.com/questions/10585029/parse-an-html-string-with-js
      // https://nordicapis.com/10-free-to-use-cors-proxies/
      // http://www.whateverorigin.org/
      // https://allorigins.win/

      class FetchPackage {
        #proxyURLAllOrigins = "https://api.allorigins.win/get?url=";
        #proxyURLThingProxy = "https://api.allorigins.win/get?url="; //'https://thingproxy.freeboard.io/fetch/'
        #proxyURLChosed = "";
        #packageName = "";
        packageList = [];

        #parseHTML = (markup) => {
          if (markup.toLowerCase().trim().indexOf("<!doctype") === 0) {
            var doc = document.implementation.createHTMLDocument("");
            doc.documentElement.innerHTML = markup;
            return doc;
          } else if ("content" in document.createElement("template")) {
            var el = document.createElement("template");
            el.innerHTML = markup;
            return el.content;
          } else {
            var docfrag = document.createDocumentFragment();
            var el = document.createElement("body");
            el.innerHTML = markup;
            for (i = 0; 0 < el.childNodes.length; ) {
              docfrag.appendChild(el.childNodes[i]);
            }
            return docfrag;
          }
        };

        fetchPackageList = (packageName) => {
          const repoURL = "https://community.chocolatey.org";
          const packageNameRegex = /(.*)<.*>.*<\/.*>/gm;
          const packageVersionRegex = /.*<.*>(.*)<\/.*>/gm;
          const packageImageRegex = /file:\/{1,}[A-Z]\:/gm;
          this.#packageName = packageName;
          const loadBalance = (min, max) => {
            return Math.floor(Math.random() * (max - min + 1) + min);
          };
          const parsePackageName = (proxyURL, packageName) => {
            return (
              proxyURL +
              encodeURIComponent(
                repoURL + "/packages?q=" + packageName.replace(/\s{1,}/gm, "+")
              )
            );
          };
          this.#proxyURLChosed =
            loadBalance(1, 2) === 1
              ? this.#proxyURLAllOrigins
              : this.#proxyURLThingProxy;
          return fetch(parsePackageName(this.#proxyURLChosed, packageName))
            .then((response) => {
              const contentType = response.headers.get("content-type");
              if (
                contentType &&
                contentType.indexOf("application/json") !== -1
              ) {
                return response.json();
              } else {
                return response.text();
              }
            })
            .then((data) => {
              const parse_html = this.#parseHTML(data.contents ?? data);
              const list = parse_html.querySelectorAll(".package-list-view li");
              for (let item of list) {
                if (
                  item.querySelector("a.h5") &&
                  item.querySelector("div.input-group input")
                ) {
                  let packageObject = {
                    packageName: item
                      .querySelector("a.h5")
                      .innerHTML.replace(packageNameRegex, "$1"),
                    packageVersion: item
                      .querySelector("a.h5")
                      .innerHTML.replace(packageVersionRegex, "$1"),
                    packageIcon:
                      repoURL +
                      item
                        .querySelector("img")
                        .src.replace(packageImageRegex, ""),
                    packageCommand: item.querySelector("input").value,
                  };
                  this.packageList.push(packageObject);
                }
              }
              return this.packageList;
            });
        };
      }

      document
        .querySelector("#getSearch")
        .addEventListener("click", (event) => {
          document.querySelector("#resultList").innerHTML = "";
          if (document.querySelector("#package").value == "") {
            return alert("Insira um pacote vÃ¡lido.");
          }
          const fetchPackageInstance = new FetchPackage();
          const packageList = fetchPackageInstance.fetchPackageList(
            event.target.form[0].value
          );
          console.log(
            fetchPackageInstance.fetchPackageList(event.target.form[0].value)
          );

          packageList.then((data) => {
            data.forEach(
              (item) =>
                (document
                  .querySelector("#resultList")
                  .appendChild(document.createElement("li")).innerHTML = `
            <div class="">
              <div class="d-flex">
                <div class="mx-auto package-image-header">
                  <div class="ratio ratio-1x1">
                    <div class="d-flex flex-fill align-items-center justify-content-center package-icon">
                      <img src="${item.packageIcon}">    
                    </div>
                  </div>
                </div>
                <div class="flex-fill ms-3">
                  <div class="d-flex align-items-sm-center">
                    <div class="d-flex mt-1 mt-sm-0">
                    </div>
                    <a class="h5 fw-bold mb-0 btn-link text-break text-reset" title="Learn more about ${
                      item.packageName
                    }" aria-label="Learn more about ${item.packageName}">${
                  item.packageName
                } <span class=""></span></a>
                  </div>
                  <div class="mt-2 d-flex align-items-center flex-wrap">
                  </div>
                </div>
              </div>
            </div>

            <div class="row mt-2 package-list-align">
              <div class="col-lg-6">       
              </div>
              <div class="mt-2 col-lg-6 mt-lg-0">
                <div class="input-group" style="width: 55px;">
                  <input type="text" id="${item.packageName
                    .split(" ")
                    .slice(0, 3)
                    .join("")
                    .toLowerCase()}" class="form-control bg-theme-light user-select-all border-start-0 ps-1" aria-label="Install ${
                  item.packageName
                } command" value="${
                  item.packageCommand
                }"  style="visibility: hidden;">
                  <button data-clipboard-target="#${item.packageName
                    .split(" ")
                    .slice(0, 3)
                    .join("")
                    .toLowerCase()}" class="btn btn-primary btn-copy tt tt-top" type="button" data-bs-toggle="button" data-tooltip-text="Install" data-tooltip-text-active="Copied!" aria-pressed="false" style="border-radius: 10px;"><i class="fas fa-clipboard" aria-hidden="true"></i></button>
                </div>
              </div>
            </div>
            <hr>
          `)
            );
          });
        });
      //https://stackoverflow.com/questions/43521856/cross-domain-javascript-calls-using-jsonp-or-cors
      //https://stackoverflow.com/questions/36568923/cors-error-with-ajax-request
    </script>
    <script language="javascript" type="text/javascript">
      ((window.gitter = {}).chat = {}).options = {
        room: "chocolatey/chocolatey.org",
      };
    </script>
    <script type="text/javascript">
      (function () {
        window["__CF$cv$params"] = {
          r: "67370f623fa82745",
          m: "a0bd3b31dfe7708fc6b1c100850bd05981cb7e7a-1627065866-1800-Acg5Z2UrLIUeDuRLFRsSHGq31R9ARDOroC/OaQR7IoWDQ0H2r6qN52Mt+I0SbG4+fUSscPAJt9ltQitN+l/CIQ14YidLhCcWPQ8JhZyWDpVgp2VM4qEJkhNu6O5cT2khbA==",
          s: [0xd2051bf884, 0x0095fdb22d],
        };
      })();
    </script>
    <script
      src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
      integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/gh/xcash/bootstrap-autocomplete@v2.3.0/dist/latest/bootstrap-autocomplete.min.js"></script>
  </body>
</html>
